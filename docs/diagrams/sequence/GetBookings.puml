@startuml Get Bookings (GET)

header GoCamply Sequence Diagram
footer Page %page% of %lastpage%
title "Get Bookings (GET)"

participant "Client" as client
participant "<<javaScript>>\n:server" as server
participant "<<router>>\n:bookings" as routerBookings
participant "<<middleware>>\n:protect" as mwProtect
participant "<<controllers>>\n:bookings" as controllersBookings
participant "<<model>>\n:Booking" as modelBooking
database "<<MongoDB>>\n:bookings" as BookingsDatabase

client->server ++: req.get('/api/v1/bookings')
server->routerBookings ++: app.use('/api/v1/bookings', bookings)
routerBookings -> mwProtect ++: protect(req)
mwProtect -> mwProtect --: verify token / set req.user
mwProtect --> routerBookings --: next()
routerBookings -> controllersBookings ++: getBookings(req)
controllersBookings -> modelBooking ++: if req.user.role !== 'admin' -> find({ user: req.user.id })
modelBooking -> BookingsDatabase ++: query user bookings
BookingsDatabase --> modelBooking --: bookings
controllersBookings <-- modelBooking --: bookings
controllersBookings -> client --: response 200 { success: true, count, data: bookings }

note over controllersBookings: If admin + campgroundId param -> find by campground

@enduml
